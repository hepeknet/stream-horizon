<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<config>
	<sourceDirectory>d:/projects/test/input</sourceDirectory>
	<archiveDirectory>d:/projects/test/archive</archiveDirectory>
	<errorDirectory>d:/projects/test/error</errorDirectory>
	<bulkOutputDirectory>d:/projects/test/bulkOutput</bulkOutputDirectory>
	<connectionProperties>
		<jdbcUrl>jdbc:oracle:thin:@192.168.52.132:1521:orcl</jdbcUrl>
		<jdbcUserName>warehouse</jdbcUserName>
		<jdbcPassword>warehouse</jdbcPassword>
	</connectionProperties>
	<databaseStringLiteral>'</databaseStringLiteral>
	<factFeeds>
		<factFeed name="NOTIF" type="full">
			<fileNameMasks>
				<fileNameMask>.*NOTIF.*</fileNameMask>
			</fileNameMasks>
			<delimiterString>^~</delimiterString>
			<header process="no_header" />
			<data process="normal">
				<eachLineStartsWithCharacter></eachLineStartsWithCharacter>
				<attributes>
					<attribute name="casparGuid" />
					<attribute name="runGuid" />
					<attribute name="taskCount" />
					<attribute name="fileCount" />
					<attribute name="persistedTaskCount" />
					<attribute name="persistedTradeCount" />
					<attribute name="persistedValidValuesCount" />
					<attribute name="persistedInvalidValuesCount" />
					<attribute name="notPersistedTaskCount" />
					<attribute name="notPersistedTradeCount" />
				</attributes>
			</data>
			<footer process="skip" />
			<bulkLoadDefinition>
				<bulkLoadOutputExtension>data</bulkLoadOutputExtension>
				<bulkLoadInsertStatement>LOAD DATA INFILE '${global.bulkFilePath}'
					INTO TABLE test_fact FIELDS TERMINATED BY '@@' LINES TERMINATED BY
					'\n'</bulkLoadInsertStatement>
				<bulkLoadFormatDefinition>
					<attributes>
						<attribute name="feed.casparGuid" />
					</attributes>
				</bulkLoadFormatDefinition>
				<onBulkLoadSuccess>
					<sqlStatements>
						<sqlStatement>CALL simpleproc(@a)</sqlStatement>
						<sqlStatement>CALL simpleproc(@b)</sqlStatement>
					</sqlStatements>
				</onBulkLoadSuccess>
			</bulkLoadDefinition>
			<onFeedProcessingCompletion>
				<sqlStatement>
				insert into RWHSTG_ETL_BATCH( FILE_ID, FILE_NAME, FILE_TYPE, FILE_CREATED_TIMESTAMP, BUSINESS_DATE, CASPAR_GUID, NUMBER_OF_ROWS, FILE_VALIDATION_FLAG, ERROR_DESCRIPTION) 
				VALUES (rwh_request_notification_seq.nextval, '${inputFeedFileName}', 'CSRISKFEED', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, '${casparGuid}', ${numberOfRowsInFeed}, '${feedProcessingSuccessFailureFlag}', '${feedProcessingErrorDescription}')
				</sqlStatement>
			</onFeedProcessingCompletion>
			<threadPoolSizes>
				<feedProcessingThreads>1</feedProcessingThreads>
				<bulkLoadProcessingThreads>0</bulkLoadProcessingThreads>
			</threadPoolSizes>
		</factFeed>
		<factFeed name="dataFeed" type="full">
			<fileNameMasks>
				<fileNameMask>.*done</fileNameMask>
			</fileNameMasks>
			<delimiterString>^$</delimiterString>
			<header process="strict">
				<eachLineStartsWithCharacter>0</eachLineStartsWithCharacter>
				<attributes>
					<attribute name="fileUserName" />
					<attribute name="qlVersion" />
					<attribute name="portfolio" />
					<attribute name="eodFlag" />
					<attribute name="location" />
					<attribute name="intradayName" />
					<attribute name="notUsed1" />
					<attribute name="notUsed2" />
					<attribute name="businessDate" />
					<attribute name="notUsed3" />
					<attribute name="rerunVersion" />
					<attribute name="curveType" />
					<attribute name="parisRequestId" />
					<attribute name="casparGuid" />
					<attribute name="rerunGuid" />
					<attribute name="requestTimestamp" />
					<attribute name="requestGuid" />
					<attribute name="runTag" />
				</attributes>
			</header>
			<data process="strict">
				<eachLineStartsWithCharacter>1</eachLineStartsWithCharacter>
				<attributes>
					<attribute name="componentCode" />
					<attribute name="factorCode" />
					<attribute name="underlyingCode" />
					<attribute name="riskUnderlyingCode" />
					<attribute name="gridCellType" />
					<attribute name="gridCellValue" />
					<attribute name="riskCurrencyCode" />
					<attribute name="riskValue" />
					<attribute name="baseCurrencyCode" />
					<attribute name="baseValue" />
					<attribute name="exceptionCode" />
					<attribute name="exceptionDescription" />
					<attribute name="exceptionFlag" />
					<attribute name="sourceName" />
					<attribute name="dealType" />
					<attribute name="dealId" />
					<attribute name="dealVersion" />
					<attribute name="dealWhatIfUID" />
					<attribute name="dealDate" />
					<attribute name="dealAmended" />
					<attribute name="dealState" />
					<attribute name="structureCd" />
					<attribute name="orgCode" />
					<attribute name="productCode" />
					<attribute name="partyName" />
					<attribute name="trade_ql" />
					<attribute name="trade_tds" />
					<attribute name="maturityDate" />
					<attribute name="localCurrencyCode" />
					<attribute name="localValue" />
					<attribute name="pricingModel" />
					<attribute name="curveType" />
				</attributes>
			</data>
			<derivedAttributes>
				<attribute name="abc">1</attribute>
			</derivedAttributes>
			<footer process="strict">
				<eachLineStartsWithCharacter>9</eachLineStartsWithCharacter>
			</footer>
			<bulkLoadDefinition>
				<bulkLoadOutputExtension>data</bulkLoadOutputExtension>
				<bulkLoadInsertStatement>LOAD DATA INFILE '${global.bulkFilePath}'
					INTO TABLE test_fact FIELDS TERMINATED BY '@@' LINES TERMINATED BY
					'\n'</bulkLoadInsertStatement>
				<bulkLoadFormatDefinition>
					<attributes>
						<attribute name="dimension.RWH_DEAL_DIM" />
						<attribute name="dimension.RWH_UNDERLYING_DIM" />
						<attribute name="dimension.RWH_RISK_STATUS_DIM" />
						<attribute name="dimension.RWH_PRODUCT_DIM" />
						<attribute name="dimension.RWH_PORTFOLIO_DIM" />
						<attribute name="dimension.RWH_PARTY_DIM" />
						<attribute name="dimension.RWH_CURRENCY_DIM" />
						<attribute name="dimension.RWH_CURVETYPE_DIM" />
						<attribute name="feed.localValue" />
						<attribute name="feed.baseValue" />
						<attribute name="feed.riskValue" />
					</attributes>
				</bulkLoadFormatDefinition>
				<onBulkLoadSuccess>
					<sqlStatements>
						<sqlStatement>CALL simpleproc(@a)</sqlStatement>
						<sqlStatement>CALL simpleproc(@b)</sqlStatement>
					</sqlStatements>
				</onBulkLoadSuccess>
			</bulkLoadDefinition>
			<threadPoolSizes>
				<feedProcessingThreads>1</feedProcessingThreads>
				<bulkLoadProcessingThreads>0</bulkLoadProcessingThreads>
			</threadPoolSizes>
		</factFeed>
	</factFeeds>
	<dimensions>
		<dimension name="RWH_UNDERLYING_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="underlyingCode" naturalKey="true" />
				<mappedColumn name="riskUnderlyingCode" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_underlying_dim(underlying_dim_wid, underlying_name, risk_underlying_name)
					values (rwh_underlying_seq.nextval,'${underlyingCode}','${riskUnderlyingCode}')
				</insertSingle>
				<selectSurrogateKey>select underlying_dim_wid from rwh_underlying_dim where underlying_name='${underlyingCode}' and risk_underlying_name='${riskUnderlyingCode}'</selectSurrogateKey>
				<preCacheKeys>select underlying_dim_wid, underlying_name, risk_underlying_name from rwh_underlying_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_RISK_STATUS_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="exceptionCode" naturalKey="true" />
				<mappedColumn name="exceptionDescription" naturalKey="true" />
				<mappedColumn name="exceptionFlag" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_risk_status_dim(risk_status_dim_wid, status_code, status_description, status_flag)
    				values (rwh_risk_status_seq.nextval, '${exceptionCode}', '${exceptionDescription}', substr('${exceptionFlag}', 0, 1))
				</insertSingle>
				<selectSurrogateKey>select risk_status_dim_wid from rwh_risk_status_dim where status_code='${exceptionCode}' and status_description='${exceptionDescription}' and status_flag=substr('${exceptionFlag}', 0, 1)</selectSurrogateKey>
				<preCacheKeys>select risk_status_dim_wid, status_code, status_description, status_flag from rwh_risk_status_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_PRODUCT_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="productCode" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_product_dim(product_dim_wid, product_code)
    				values (rwh_product_seq.nextval, '${productCode}')
				</insertSingle>
				<selectSurrogateKey>select product_dim_wid from rwh_product_dim where product_code='${productCode}'</selectSurrogateKey>
				<preCacheKeys>select product_dim_wid, product_code from rwh_product_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_PORTFOLIO_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="portfolio" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_portfolio_dim(portfolio_dim_wid, portfolio_name)
    				values (rwh_portfolio_seq.nextval, '${header.portfolio}')
				</insertSingle>
				<selectSurrogateKey>select portfolio_dim_wid from rwh_portfolio_dim where portfolio_name='${header.portfolio}'</selectSurrogateKey>
				<preCacheKeys>select portfolio_dim_wid, portfolio_name from rwh_portfolio_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_PARTY_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="partyName" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_party_dim(party_dim_wid, party_name)
    				values (rwh_party_seq.nextval, '${partyName}')
				</insertSingle>
				<selectSurrogateKey>select party_dim_wid from rwh_party_dim where party_name='${partyName}'</selectSurrogateKey>
				<preCacheKeys>select party_dim_wid, party_name from rwh_party_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_CURRENCY_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="baseCurrencyCode" naturalKey="true" />
				<mappedColumn name="riskCurrencyCode" naturalKey="true" />
				<mappedColumn name="localCurrencyCode" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_currency_dim(CURRENCY_DIM_WID, BASE_CURRENCY, BASE_CURRENCY_DESC, RISK_CURRENCY, RISK_CURRENCY_DESC, LOCAL_CURRENCY, LOCAL_CURRENCY_DESC) 
					values (rwh_currency_seq.nextval, '${baseCurrencyCode}', '${baseCurrencyCode}', '${riskCurrencyCode}', '${riskCurrencyCode}', '${localCurrencyCode}', '${localCurrencyCode}')
				</insertSingle>
				<selectSurrogateKey>select CURRENCY_DIM_WID from rwh_currency_dim where BASE_CURRENCY='${baseCurrencyCode}' and RISK_CURRENCY='${riskCurrencyCode}' and LOCAL_CURRENCY='${localCurrencyCode}'</selectSurrogateKey>
				<preCacheKeys>select CURRENCY_DIM_WID, BASE_CURRENCY, RISK_CURRENCY, LOCAL_CURRENCY from rwh_currency_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_CURVETYPE_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="curveType" naturalKey="true" />
				<mappedColumn name="pricingModel" naturalKey="true" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_curvetype_dim(curvetype_dim_wid, curve_type_code, curve_type_desc, pricing_model)
    				values (rwh_curve_type_seq.nextval, '${curveType}', '${curveType}', '${pricingModel}')
				</insertSingle>
				<selectSurrogateKey>select curvetype_dim_wid from rwh_curvetype_dim where curve_type_code='${curveType}' and pricing_model='${pricingModel}'</selectSurrogateKey>
				<preCacheKeys>select curvetype_dim_wid, curve_type_code, pricing_model from rwh_curvetype_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_DATE_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="businessDate" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into WAREHOUSE.RWH_DATE_DIM(DATE_DIM_WID, BUSINESS_DATE)
					values (TO_NUMBER(TO_CHAR(TO_TIMESTAMP('${businessDate}', 'DD/MM/YYYY HH24:MI:SS'), 'YYYYMMDD')), TO_TIMESTAMP('${businessDate}', 'DD/MM/YYYY HH24:MI:SS'))
				</insertSingle>
				<selectSurrogateKey>select DATE_DIM_WID from RWH_DATE_DIM where BUSINESS_DATE=TO_TIMESTAMP('${businessDate}', 'DD/MM/YYYY HH24:MI:SS')</selectSurrogateKey>
				<preCacheKeys>select DATE_DIM_WID, BUSINESS_DATE from RWH_DATE_DIM</preCacheKeys>
			</sqlStatements>
		</dimension>
		<dimension name="RWH_DEAL_DIM" type="T1_INSERT_ONLY">
			<mappedColumns>
				<mappedColumn name="sourceName" naturalKey="true" />
				<mappedColumn name="dealType" naturalKey="true" />
				<mappedColumn name="dealId" naturalKey="true" />
				<mappedColumn name="dealVersion" naturalKey="true" />
				<mappedColumn name="dealWhatIfUID" naturalKey="true" />
				<mappedColumn name="componentCode" naturalKey="true" />
				<mappedColumn name="trade_tds" />
				<mappedColumn name="dealAmended" />
				<mappedColumn name="structureCd" />
				<mappedColumn name="maturityDate" />
				<mappedColumn name="dealDate" />
				<mappedColumn name="dealState" />
			</mappedColumns>
			<sqlStatements>
				<insertSingle>
					insert into rwh_deal_dim(deal_dim_wid, sourceName, deal_type, deal_id, deal_version, deal_Whatif_uid, component_code,
       					deal_date, deal_amended, deal_state, deal_structure_CD, deal_additional_info, maturity_date, deal_additional_info_cube, dealInCubeGeneration)
    				values (rwh_deal_seq.nextval, '${sourceName}', '${dealType}', '${dealId}', ${dealVersion}, '${dealWhatIfUID}', '${componentCode}', TO_DATE('${dealDate}', 'DD/MM/YYYY'), TO_DATE('${dealAmended}', 'DD/MM/YYYY'),
    				'${dealState}', '${structureCd}', '${trade_tds}', TO_DATE('${maturityDate}', 'DD/MM/YYYY'), '${trade_tds}', NULL)
				</insertSingle>
				<selectSurrogateKey>select deal_dim_wid from rwh_deal_dim where sourceName='${sourceName}' and deal_type='${dealType}' and deal_id='${dealId}' and deal_version='${dealVersion}' and DEAL_WHATIF_UID='${dealWhatIfUID}' and component_code='${componentCode}'</selectSurrogateKey>
				<preCacheKeys>select deal_dim_wid, sourceName, deal_type, deal_id, deal_version, DEAL_WHATIF_UID, component_code from rwh_deal_dim</preCacheKeys>
			</sqlStatements>
		</dimension>
	</dimensions>
</config>
